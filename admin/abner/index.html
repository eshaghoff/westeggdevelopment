<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>Abner</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f4f4f8; color: #333; min-height: 100vh;
}

.container {
  max-width: 860px; margin: 20px auto; background: #fff;
  border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.header {
  background: linear-gradient(135deg, #1a1a2e 0%, #1a2435 100%);
  padding: 18px 28px; display: flex; align-items: center; justify-content: space-between;
}
.header h1 { color: #3498db; font-size: 22px; letter-spacing: 1px; margin: 0; }
.header p { color: #6a8db5; font-size: 11px; letter-spacing: 2px; margin-top: 4px; }
.back-link {
  color: #556; text-decoration: none; font-size: 12px;
  letter-spacing: 1px; transition: color 0.2s;
}
.back-link:hover { color: #3498db; }

/* Connection bar */
.conn-bar {
  padding: 4px 28px; font-size: 10px; display: flex;
  align-items: center; justify-content: space-between;
  background: #f0f0f4; border-bottom: 1px solid #eee;
}
.conn-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 4px; }
.conn-dot.online { background: #27ae60; }
.conn-dot.offline { background: #e74c3c; }
.conn-status { color: #999; }
.conn-config {
  color: #aaa; font-size: 10px; cursor: pointer;
  border: none; background: none; font-family: inherit;
}
.conn-config:hover { color: #3498db; }

/* Stats */
.stats-bar { background: #3498db; padding: 12px 28px; display: flex; gap: 0; flex-wrap: wrap; }
.stat { flex: 1; min-width: 90px; text-align: center; padding: 4px 6px; }
.stat:not(:last-child) { border-right: 1px solid rgba(255,255,255,0.2); }
.stat-value { color: #fff; font-size: 18px; font-weight: 700; }
.stat-label { color: rgba(255,255,255,0.75); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }

/* Tabs */
.tabs { display: flex; border-bottom: 1px solid #eee; padding: 0 28px; }
.tab {
  padding: 10px 16px; font-size: 12px; font-weight: 600; color: #999;
  cursor: pointer; border-bottom: 2px solid transparent;
  transition: color 0.2s, border-color 0.2s; letter-spacing: 0.5px;
}
.tab:hover { color: #555; }
.tab.active { color: #3498db; border-bottom-color: #3498db; }

.tab-content { display: none; padding: 16px 28px; }
.tab-content.active { display: block; }

/* Tables */
table { width: 100%; border-collapse: collapse; font-size: 12px; }
th {
  text-align: left; padding: 6px 8px; font-size: 10px;
  letter-spacing: 0.5px; color: #999; text-transform: uppercase;
  border-bottom: 1px solid #eee;
}
td { padding: 8px 8px; border-bottom: 1px solid #f5f5f5; vertical-align: top; }
tr:hover td { background: rgba(52, 152, 219, 0.04); }

.amount { font-variant-numeric: tabular-nums; }
.amount.positive { color: #27ae60; }
.amount.negative { color: #e74c3c; }

.type-badge {
  display: inline-block; padding: 2px 8px; border-radius: 3px;
  font-size: 10px; font-weight: 600; letter-spacing: 0.3px;
}
.type-badge.expense { background: #f8d7da; color: #721c24; }
.type-badge.contribution { background: #d4edda; color: #155724; }
.type-badge.revenue { background: #cce5ff; color: #004085; }
.type-badge.kpa_expense { background: #fff3cd; color: #856404; }

/* Deal cards */
.deal-card {
  border: 1px solid #eee; border-radius: 8px; padding: 12px 16px;
  margin-bottom: 10px; cursor: pointer; transition: border-color 0.2s;
}
.deal-card:hover { border-color: #3498db; }
.deal-card.expanded { border-color: #3498db; }
.deal-name { font-size: 14px; font-weight: 700; color: #1a2435; }
.deal-stats { display: flex; gap: 16px; margin-top: 6px; font-size: 12px; color: #666; }
.deal-detail { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
.deal-card.expanded .deal-detail { display: block; }
.deal-sub { font-size: 11px; font-weight: 700; color: #999; letter-spacing: 0.5px; margin: 8px 0 4px; }

/* Category list */
.cat-row { display: flex; justify-content: space-between; font-size: 12px; padding: 2px 0; }
.cat-name { color: #555; }
.cat-total { font-variant-numeric: tabular-nums; color: #333; font-weight: 600; }

.footer { background: #f8f8fa; padding: 10px 28px; text-align: center; border-top: 1px solid #eee; }
.footer p { color: #bbb; font-size: 10px; }

.loading { text-align: center; padding: 40px; color: #999; font-size: 13px; }

/* Toast */
.toast {
  position: fixed; top: 16px; right: 16px;
  background: #1a2435; color: #3498db;
  padding: 10px 20px; border-radius: 8px;
  font-size: 13px; font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  opacity: 0; transform: translateY(-10px);
  transition: opacity 0.3s, transform 0.3s;
  z-index: 1000; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateY(0); }

/* Config modal */
.modal-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal {
  background: #fff; border-radius: 12px; padding: 24px;
  max-width: 420px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}
.modal h3 { font-size: 14px; margin-bottom: 12px; color: #1a2435; }
.modal label { font-size: 11px; color: #666; display: block; margin-bottom: 4px; }
.modal input {
  width: 100%; padding: 8px 12px; border: 1.5px solid #ddd;
  border-radius: 6px; font-size: 12px; font-family: inherit;
  outline: none; margin-bottom: 12px;
}
.modal input:focus { border-color: #3498db; }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
.modal-actions button {
  padding: 6px 16px; border-radius: 6px; font-size: 12px;
  font-weight: 600; cursor: pointer; font-family: inherit;
  border: 1px solid #ddd; background: #fff; color: #333;
}
.modal-actions .save-btn { background: #3498db; color: #fff; border-color: #3498db; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-left">
      <h1>ABNER</h1>
      <p>ACCOUNTING AGENT</p>
    </div>
    <a class="back-link" href="../">&larr; ADMIN</a>
  </div>

  <div class="conn-bar">
    <span class="conn-status"><span class="conn-dot" id="conn-dot"></span><span id="conn-text">Checking...</span></span>
    <button class="conn-config" onclick="openConfig()">configure</button>
  </div>

  <div class="stats-bar">
    <div class="stat"><div class="stat-value" id="s-deals">-</div><div class="stat-label">Deals</div></div>
    <div class="stat"><div class="stat-value" id="s-invested">-</div><div class="stat-label">Invested</div></div>
    <div class="stat"><div class="stat-value" id="s-spent">-</div><div class="stat-label">Spent</div></div>
    <div class="stat"><div class="stat-value" id="s-revenue">-</div><div class="stat-label">Revenue</div></div>
    <div class="stat"><div class="stat-value" id="s-kpa">-</div><div class="stat-label">KPA YTD</div></div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="recent" onclick="switchTab('recent', this)">Recent</div>
    <div class="tab" data-tab="deals" onclick="switchTab('deals', this)">Deals</div>
    <div class="tab" data-tab="llc" onclick="switchTab('llc', this)">LLC</div>
    <div class="tab" data-tab="kpa" onclick="switchTab('kpa', this)">KPA</div>
  </div>

  <div class="tab-content active" id="tab-recent">
    <div id="recent-table"><div class="loading">Loading...</div></div>
  </div>

  <div class="tab-content" id="tab-deals">
    <div id="deals-list"><div class="loading">Loading...</div></div>
  </div>

  <div class="tab-content" id="tab-llc">
    <div id="llc-cats"></div>
    <div id="llc-table"><div class="loading">Loading...</div></div>
  </div>

  <div class="tab-content" id="tab-kpa">
    <div id="kpa-cats"></div>
    <div id="kpa-table"><div class="loading">Loading...</div></div>
  </div>

  <div class="footer"><p id="sync-time">Loading...</p></div>
</div>

<div class="toast" id="toast"></div>

<!-- Config modal -->
<div class="modal-overlay" id="config-modal">
  <div class="modal">
    <h3>API Connection</h3>
    <label>Abner API URL</label>
    <input type="text" id="cfg-api-url" placeholder="http://localhost:5153">
    <div class="modal-actions">
      <button onclick="closeConfig()">Cancel</button>
      <button class="save-btn" onclick="saveConfig()">Save & Test</button>
    </div>
  </div>
</div>

<script>
// --- Config ---
let API_URL = localStorage.getItem('abner_api_url') || '';
let apiOnline = false;

async function loadConfig() {
  try {
    const res = await fetch('../config.json?_=' + Date.now(), { signal: AbortSignal.timeout(3000) });
    if (res.ok) {
      const cfg = await res.json();
      if (cfg.abner_api && !localStorage.getItem('abner_api_url')) {
        API_URL = cfg.abner_api;
      }
    }
  } catch (e) {}
  if (!API_URL) API_URL = 'http://127.0.0.1:5153';
}

function $(id) { return document.getElementById(id); }
function fmt(n) { return '$' + (n || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
function fmtk(n) {
  if (n >= 1000000) return '$' + (n / 1000000).toFixed(1) + 'M';
  if (n >= 10000) return '$' + (n / 1000).toFixed(0) + 'k';
  if (n >= 1000) return '$' + (n / 1000).toFixed(1) + 'k';
  return fmt(n);
}
function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function showToast(msg, dur = 3000) {
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
}

// --- Connection ---
async function apiGet(path) {
  const res = await fetch(API_URL + path, { signal: AbortSignal.timeout(5000) });
  return res;
}

async function checkConnection() {
  const dot = $('conn-dot');
  const text = $('conn-text');
  try {
    const res = await fetch(API_URL + '/health', { signal: AbortSignal.timeout(3000) });
    if (res.ok) {
      apiOnline = true;
      dot.className = 'conn-dot online';
      text.textContent = 'Connected';
      return true;
    }
  } catch (e) {}
  apiOnline = false;
  dot.className = 'conn-dot offline';
  text.textContent = 'Offline';
  return false;
}

function openConfig() {
  $('cfg-api-url').value = API_URL;
  $('config-modal').classList.add('show');
}
function closeConfig() { $('config-modal').classList.remove('show'); }

async function saveConfig() {
  API_URL = $('cfg-api-url').value.replace(/\/+$/, '');
  localStorage.setItem('abner_api_url', API_URL);
  const ok = await checkConnection();
  if (ok) { showToast('Connected!'); closeConfig(); loadAllData(); }
  else { showToast('Connection failed'); }
}

// --- Tabs ---
function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  $(`tab-${name}`).classList.add('active');
  el.classList.add('active');
}

// --- Data loading ---
async function loadAllData() {
  if (!apiOnline) {
    document.querySelectorAll('.tab-content').forEach(t => {
      t.innerHTML = '<div class="loading">Not connected. Click configure.</div>';
    });
    return;
  }

  try {
    const [summaryRes, recentRes, dealsRes, llcRes, kpaRes] = await Promise.all([
      apiGet('/api/summary'),
      apiGet('/api/recent?limit=20'),
      apiGet('/api/deals'),
      apiGet('/api/llc'),
      apiGet('/api/kpa'),
    ]);

    const summary = await summaryRes.json();
    const recent = await recentRes.json();
    const deals = await dealsRes.json();
    const llc = await llcRes.json();
    const kpa = await kpaRes.json();

    renderStats(summary);
    renderRecent(recent);
    renderDeals(deals);
    renderLLC(llc);
    renderKPA(kpa);

    $('sync-time').textContent = 'Live: ' + new Date().toLocaleString('en-US', {
      month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
    });
  } catch (e) {
    console.error('Load failed:', e);
    $('sync-time').textContent = 'Error loading data';
  }
}

function renderStats(s) {
  $('s-deals').textContent = s.deal_count;
  $('s-invested').textContent = fmtk(s.total_invested);
  $('s-spent').textContent = fmtk(s.total_spent);
  $('s-revenue').textContent = fmtk(s.total_revenue);
  $('s-kpa').textContent = fmtk(s.kpa_total);
}

function renderRecent(entries) {
  if (!entries || entries.length === 0) {
    $('recent-table').innerHTML = '<div class="loading">No entries yet. Text an expense to get started.</div>';
    return;
  }

  let html = '<table><tr><th>Date</th><th>Type</th><th>Amount</th><th>Details</th><th>Deal</th></tr>';
  entries.forEach(e => {
    const typeClass = e.type;
    const typeLabel = e.type.replace('_', ' ').toUpperCase();
    const isCredit = e.type === 'contribution' || e.type === 'revenue';

    let details = '';
    if (e.type === 'expense') {
      details = [e.category, e.paid_to, e.description].filter(Boolean).join(' / ');
    } else if (e.type === 'contribution') {
      details = [e.contributor, e.method, e.description].filter(Boolean).join(' / ');
    } else if (e.type === 'revenue') {
      details = [e.paid_from, e.method, e.description].filter(Boolean).join(' / ');
    } else {
      details = [e.vendor, e.category, e.description].filter(Boolean).join(' / ');
    }

    html += `<tr>
      <td style="white-space:nowrap">${escapeHtml(e.date)}</td>
      <td><span class="type-badge ${typeClass}">${typeLabel}</span></td>
      <td class="amount ${isCredit ? 'positive' : 'negative'}">${isCredit ? '+' : '-'}${fmt(e.amount)}</td>
      <td style="font-size:11px;max-width:250px;overflow:hidden;text-overflow:ellipsis">${escapeHtml(details)}</td>
      <td style="font-size:11px;color:#666">${escapeHtml(e.deal || '')}</td>
    </tr>`;
  });
  html += '</table>';
  $('recent-table').innerHTML = html;
}

function renderDeals(deals) {
  if (!deals || deals.length === 0) {
    $('deals-list').innerHTML = '<div class="loading">No deals yet.</div>';
    return;
  }

  let html = '';
  deals.forEach(d => {
    const capsHtml = Object.entries(d.capital_accounts || {})
      .sort((a, b) => b[1] - a[1])
      .map(([name, amt]) => `<div class="cat-row"><span class="cat-name">${escapeHtml(name)}</span><span class="cat-total">${fmt(amt)}</span></div>`)
      .join('');

    html += `<div class="deal-card" onclick="this.classList.toggle('expanded')">
      <div class="deal-name">${escapeHtml(d.name)}</div>
      <div class="deal-stats">
        <span>In: ${fmtk(d.total_contributions)}</span>
        <span>Out: ${fmtk(d.total_expenses)}</span>
        ${d.total_revenues > 0 ? `<span>Rev: ${fmtk(d.total_revenues)}</span>` : ''}
        <span style="font-weight:700;color:${d.net >= 0 ? '#27ae60' : '#e74c3c'}">Bal: ${fmtk(d.net)}</span>
      </div>
      <div class="deal-detail">
        ${capsHtml ? `<div class="deal-sub">CAPITAL ACCOUNTS</div>${capsHtml}` : ''}
      </div>
    </div>`;
  });
  $('deals-list').innerHTML = html;
}

function renderLLC(llc) {
  // Category breakdown
  let catHtml = '';
  if (llc.categories && llc.categories.length > 0) {
    catHtml = '<div style="margin-bottom:12px"><div class="deal-sub">BY CATEGORY</div>';
    llc.categories.forEach(c => {
      catHtml += `<div class="cat-row"><span class="cat-name">${escapeHtml(c.category)} <span style="color:#bbb">(${c.count})</span></span><span class="cat-total">${fmt(c.total)}</span></div>`;
    });
    catHtml += `<div class="cat-row" style="border-top:1px solid #eee;padding-top:4px;margin-top:4px"><span class="cat-name" style="font-weight:700">Total</span><span class="cat-total" style="font-weight:700">${fmt(llc.grand_total)}</span></div>`;
    catHtml += '</div>';
  }
  $('llc-cats').innerHTML = catHtml;

  // Expense list
  if (!llc.expenses || llc.expenses.length === 0) {
    $('llc-table').innerHTML = '<div class="loading">No LLC expenses.</div>';
    return;
  }

  let html = '<table><tr><th>Date</th><th>Amount</th><th>Category</th><th>Paid To</th><th>Description</th></tr>';
  llc.expenses.forEach(e => {
    html += `<tr>
      <td style="white-space:nowrap">${escapeHtml(e.date)}</td>
      <td class="amount negative">${fmt(e.amount)}</td>
      <td style="font-size:11px">${escapeHtml(e.category)}</td>
      <td style="font-size:11px">${escapeHtml(e.paid_to)}</td>
      <td style="font-size:11px;color:#666">${escapeHtml(e.description)}</td>
    </tr>`;
  });
  html += '</table>';
  $('llc-table').innerHTML = html;
}

function renderKPA(kpa) {
  // Category breakdown
  let catHtml = '';
  if (kpa.categories && kpa.categories.length > 0) {
    catHtml = '<div style="margin-bottom:12px"><div class="deal-sub">BY CATEGORY</div>';
    kpa.categories.forEach(c => {
      catHtml += `<div class="cat-row"><span class="cat-name">${escapeHtml(c.category)} <span style="color:#bbb">(${c.count})</span></span><span class="cat-total">${fmt(c.total)}</span></div>`;
    });
    catHtml += `<div class="cat-row" style="border-top:1px solid #eee;padding-top:4px;margin-top:4px"><span class="cat-name" style="font-weight:700">Total (${kpa.count})</span><span class="cat-total" style="font-weight:700">${fmt(kpa.total)}</span></div>`;
    catHtml += '</div>';
  }
  $('kpa-cats').innerHTML = catHtml;

  // Expense list
  if (!kpa.expenses || kpa.expenses.length === 0) {
    $('kpa-table').innerHTML = '<div class="loading">No KPA expenses.</div>';
    return;
  }

  let html = '<table><tr><th>Date</th><th>Amount</th><th>Vendor</th><th>Category</th><th>Notes</th></tr>';
  kpa.expenses.forEach(e => {
    html += `<tr>
      <td style="white-space:nowrap">${escapeHtml(e.date)}</td>
      <td class="amount negative">${fmt(e.amount)}</td>
      <td style="font-size:11px">${escapeHtml(e.vendor)}${e.recurring ? ' <span style="color:#27ae60;font-size:9px">REC</span>' : ''}</td>
      <td style="font-size:11px">${escapeHtml(e.category)}</td>
      <td style="font-size:11px;color:#666">${escapeHtml(e.description)}</td>
    </tr>`;
  });
  html += '</table>';
  $('kpa-table').innerHTML = html;
}

// --- Init ---
(async () => {
  await loadConfig();
  await checkConnection();
  loadAllData();
})();
setInterval(loadAllData, 30000);
</script>
</body>
</html>
